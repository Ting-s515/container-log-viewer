# Container Log Viewer - Docker Compose 部署設定
#
# 使用方式：
#   1. 複製 .env.example 為 .env
#   2. 修改 .env 中的 port 設定
#   3. 執行 docker-compose up -d --build
#
# 或直接在命令列指定 port：
#   CLIENT_PORT=8080 SERVER_PORT=3001 docker-compose up -d --build
#
# 注意：需掛載 /var/run/docker.sock 才能存取主機的 Docker

services:
  # 後端服務
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    ports:
      - "${SERVER_PORT:-3001}:3001"
    volumes:
      # 掛載 Docker socket，讓容器內可以存取主機的 Docker/Podman
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - PORT=3001
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 前端服務（nginx 提供靜態檔案 + 代理 API）
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    ports:
      - "${CLIENT_PORT:-80}:80"
    depends_on:
      - server
    restart: unless-stopped
